name: Reusable Debian Package Build & Publish

on:
  workflow_call:
    inputs:
      component:
        description: 'APT component (base, feelpp, applications, ktirio)'
        required: true
        type: string
      distributions:
        description: 'JSON array of distributions to build for, e.g. ["noble", "trixie"]'
        required: false
        type: string
        default: '["noble"]'
      architectures:
        description: 'JSON array of architectures to build for, e.g. ["amd64", "arm64"]'
        required: false
        type: string
        default: '["amd64"]'
      build-script:
        description: 'Path to build script relative to repo root (not used with pbuilder)'
        required: false
        type: string
        default: 'debian/build-deb.sh'
      package-pattern:
        description: 'Pattern to match .deb files (relative to parent dir of repo)'
        required: false
        type: string
        default: '../*.deb'
      build-dependencies:
        description: 'Additional build dependencies to install (not used with pbuilder, use debian/control)'
        required: false
        type: string
        default: ''
      use-pbuilder:
        description: 'Use pbuilder for clean chroot builds (recommended)'
        required: false
        type: boolean
        default: true
      runs-on:
        description: 'Runner to use for builds'
        required: false
        type: string
        default: 'ubuntu-24.04'
      sign-packages:
        description: 'Sign packages with GPG (recommended for stable channel)'
        required: false
        type: boolean
        default: false
    secrets:
      gpg-key-id:
        description: 'GPG key ID for signing (required if sign-packages=true)'
        required: false
      gpg-passphrase:
        description: 'GPG passphrase for signing'
        required: false

jobs:
  build-deb:
    name: Build Debian Package (${{ matrix.distribution }}-${{ matrix.architecture }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        distribution: ${{ fromJSON(inputs.distributions) }}
        architecture: ${{ fromJSON(inputs.architectures) }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache pbuilder base tarball
      if: inputs.use-pbuilder
      uses: actions/cache@v4
      with:
        path: ~/pbuilder/${{ matrix.distribution }}-${{ matrix.architecture }}-base.tgz
        key: pbuilder-${{ matrix.distribution }}-${{ matrix.architecture }}-${{ runner.os }}-v1
        restore-keys: |
          pbuilder-${{ matrix.distribution }}-${{ matrix.architecture }}-${{ runner.os }}-
    
    - name: Install pbuilder-dist
      if: inputs.use-pbuilder
      run: |
        sudo apt-get update
        sudo apt-get install -y ubuntu-dev-tools build-essential devscripts debhelper
        
        # ubuntu-dev-tools includes pbuilder-dist
        # build-essential and devscripts provide tools for creating source packages
        # debhelper provides dh command needed by debian/rules
        echo "Installed pbuilder-dist and source package build tools"
    
    - name: Create or update pbuilder environment
      if: inputs.use-pbuilder
      run: |
        # Create if doesn't exist, update if it does
        if [ -f ~/pbuilder/${{ matrix.distribution }}-${{ matrix.architecture }}-base.tgz ]; then
          echo "Updating existing pbuilder environment for ${{ matrix.distribution }}-${{ matrix.architecture }}..."
          pbuilder-dist ${{ matrix.distribution }} ${{ matrix.architecture }} update
        else
          echo "Creating new pbuilder environment for ${{ matrix.distribution }}-${{ matrix.architecture }}..."
          pbuilder-dist ${{ matrix.distribution }} ${{ matrix.architecture }} create
        fi
    
    - name: Install base build dependencies (legacy mode)
      if: ${{ !inputs.use-pbuilder }}
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential debhelper cmake devscripts
    
    - name: Install additional dependencies (legacy mode)
      if: ${{ !inputs.use-pbuilder && inputs.build-dependencies != '' }}
      run: |
        sudo apt-get install -y ${{ inputs.build-dependencies }}
    
    - name: Build Debian source package
      if: inputs.use-pbuilder
      run: |
        echo "Creating Debian source package..."
        # Build source package (.dsc, .orig.tar.gz, .debian.tar.xz)
        dpkg-buildpackage -S -us -uc -d
        
        echo "Source package created:"
        ls -lh ../*.dsc
    
    - name: Build Debian package with pbuilder-dist
      if: inputs.use-pbuilder
      run: |
        echo "Building package for ${{ matrix.distribution }}-${{ matrix.architecture }} with pbuilder-dist..."
        
        # Find the .dsc file
        DSC_FILE=$(ls ../*.dsc | head -n1)
        echo "Building from: $DSC_FILE"
        
        # pbuilder-dist builds the package in a clean chroot
        # Results are placed in ~/pbuilder/<dist>_result/ (note: no arch suffix in result dir)
        pbuilder-dist ${{ matrix.distribution }} ${{ matrix.architecture }} build "$DSC_FILE"
        
        echo "Build completed successfully!"
        # The result directory is named <dist>_result (not <dist>-<arch>_result)
        ls -lh ~/pbuilder/${{ matrix.distribution }}_result/*.deb
    
    - name: Build Debian package (legacy mode)
      if: ${{ !inputs.use-pbuilder }}
      run: |
        if [[ -x "${{ inputs.build-script }}" ]]; then
          ${{ inputs.build-script }}
        else
          dpkg-buildpackage -us -uc -b
        fi
    
    - name: Collect generated packages
      run: |
        # Copy packages to current directory for artifact upload
        # GitHub Actions v4 doesn't support ../ patterns
        mkdir -p debian-packages
        
        if [ "${{ inputs.use-pbuilder }}" = "true" ]; then
          # pbuilder-dist results are in ~/pbuilder/<dist>_result/ (no arch suffix)
          RESULT_DIR=~/pbuilder/${{ matrix.distribution }}_result
          if ls $RESULT_DIR/*.deb 1> /dev/null 2>&1; then
            cp $RESULT_DIR/*.deb debian-packages/
            echo "Collected pbuilder packages:"
            ls -lh debian-packages/*.deb
          else
            echo "ERROR: No .deb files found in $RESULT_DIR"
            exit 1
          fi
        else
          # Legacy mode: packages in parent directory
          if ls ${{ inputs.package-pattern }} 1> /dev/null 2>&1; then
            cp ${{ inputs.package-pattern }} debian-packages/
            echo "Collected packages:"
            ls -lh debian-packages/*.deb
          else
            echo "Error: No packages found matching pattern: ${{ inputs.package-pattern }}"
            exit 1
          fi
        fi
        
        # Create metadata file to track distribution and architecture
        echo "${{ matrix.distribution }}" > debian-packages/DISTRIBUTION
        echo "${{ matrix.architecture }}" > debian-packages/ARCHITECTURE
    
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-${{ matrix.distribution }}-${{ matrix.architecture }}
        path: debian-packages/
        retention-days: 30

  publish:
    name: Publish to APT Repository (${{ matrix.distribution }}-${{ matrix.architecture }})
    runs-on: ubuntu-24.04
    needs: build-deb
    strategy:
      fail-fast: false
      matrix:
        distribution: ${{ fromJSON(inputs.distributions) }}
        architecture: ${{ fromJSON(inputs.architectures) }}
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')) ||
      github.event_name == 'pull_request'
    
    steps:
    - name: Determine channel
      id: channel
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "channel=stable" >> $GITHUB_OUTPUT
          echo "Channel: stable (triggered by release)"
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          echo "channel=testing" >> $GITHUB_OUTPUT
          echo "Channel: testing (triggered by push to main/master)"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "channel=pr" >> $GITHUB_OUTPUT
          echo "Channel: pr (triggered by pull request)"
        fi
    
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: deb-${{ matrix.distribution }}-${{ matrix.architecture }}
    
    - name: List downloaded packages
      run: |
        echo "Downloaded packages for ${{ matrix.distribution }}-${{ matrix.architecture }}:"
        ls -lh *.deb
        cat DISTRIBUTION ARCHITECTURE
    
    - name: Checkout APT repository
      uses: actions/checkout@v4
      with:
        repository: feelpp/apt
        ref: main
        path: apt-repo
    
    - name: Configure git credentials for GitHub
      run: |
        # Configure git globally
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Set up git credential helper to use GitHub token
        git config --global credential.helper store
        echo "https://x-access-token:${{ github.token }}@github.com" > ~/.git-credentials
        chmod 600 ~/.git-credentials
        
        echo "Git authentication configured for GitHub"
    
    - name: Setup aptly and publish
      uses: feelpp/setup-aptly@v2
      with:
        publish: true
        component: ${{ inputs.component }}
        channel: ${{ steps.channel.outputs.channel }}
        distribution: ${{ matrix.distribution }}
        debs-path: .
        apt-repo-path: apt-repo
        sign: ${{ inputs.sign-packages }}
        gpg-key-id: ${{ secrets.gpg-key-id }}
        gpg-passphrase: ${{ secrets.gpg-passphrase }}
    
    - name: Summary
      run: |
        echo "### ðŸ“¦ Package Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Component:** ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
        echo "**Channel:** ${{ steps.channel.outputs.channel }}" >> $GITHUB_STEP_SUMMARY
        echo "**Distribution:** ${{ matrix.distribution }}" >> $GITHUB_STEP_SUMMARY
        echo "**Architecture:** ${{ matrix.architecture }}" >> $GITHUB_STEP_SUMMARY
        echo "**Signed:** ${{ inputs.sign-packages && 'âœ… Yes' || 'âŒ No' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** https://feelpp.github.io/apt/${{ steps.channel.outputs.channel }}/dists/${{ matrix.distribution }}/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To use this package:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "deb [arch=${{ matrix.architecture }}] https://feelpp.github.io/apt/${{ steps.channel.outputs.channel }} ${{ matrix.distribution }} ${{ inputs.component }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
